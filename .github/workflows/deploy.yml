name: Deploy via SCP (Offline Mode)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. æ‹‰å–ä»£ç 
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. æ„å»ºé•œåƒ (åœ¨ GitHub æœåŠ¡å™¨ä¸Šæ„å»ºï¼Œç½‘ç»œæ²¡é—®é¢˜)
    - name: Build Docker Image
      run: |
        # è¿™é‡Œçš„ç”¨æˆ·åæ¢æˆæ‚¨çš„
        docker build -t ${{ secrets.DOCKER_USERNAME }}/bug-bounty-lite-vue:latest .

    # 3. å°†é•œåƒä¿å­˜ä¸ºæ–‡ä»¶
    - name: Save Image to Tar
      run: |
        docker save -o vue-deploy.tar ${{ secrets.DOCKER_USERNAME }}/bug-bounty-lite-vue:latest

    # 4. ä½¿ç”¨ SCP å°†æ–‡ä»¶ä¼ åˆ°æœåŠ¡å™¨ (è¿™ä¸€æ­¥æœ€å…³é”®)
    - name: Copy File to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "vue-deploy.tar"
        target: "/opt/deploy/"

    # 5. SSH ç™»å½•æœåŠ¡å™¨è¿›è¡ŒåŠ è½½å’Œé‡å¯
    - name: Load Image and Restart
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "ğŸ“¦ æ¥æ”¶åˆ°ç¦»çº¿é•œåƒåŒ…ï¼Œå¼€å§‹åŠ è½½..."
          cd /opt/deploy
          
          # 1. åŠ è½½é•œåƒ (ä¸éœ€è¦è”ç½‘)
          docker load -i vue-deploy.tar
          
          # 2. é‡å¯å®¹å™¨
          docker compose up -d vue-app
          
          # 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ (é‡Šæ”¾ç©ºé—´)
          rm vue-deploy.tar
          docker image prune -f
          
          echo "âœ… ç¦»çº¿éƒ¨ç½²æˆåŠŸï¼"