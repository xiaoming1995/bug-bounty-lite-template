name: Deploy Vue to Docker Hub

on:
  push:
    branches: [ "main" ] # åªæœ‰æ¨é€åˆ° main åˆ†æ”¯æ‰è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨ GitHub æä¾›çš„æœåŠ¡å™¨

    steps:
    # 1. æ‹‰å–ä»£ç 
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. ç™»å½• Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        # è¿™é‡Œçš„ secrets éœ€è¦æ‚¨åœ¨ GitHub ä»“åº“è®¾ç½®é‡Œé…ç½®
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. æ„å»ºå¹¶æ¨é€é•œåƒ
    - name: Build and Push
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        # âš ï¸ è‡ªåŠ¨æ‹¼æ¥ï¼šç”¨æˆ·å/é¡¹ç›®å:latest
        tags: ${{ secrets.DOCKER_USERNAME }}/bug-bounty-lite-vue:latest

    # 4. è¿œç¨‹è¿æ¥æœåŠ¡å™¨è¿›è¡Œæ›´æ–°
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
          cd /opt/deploy
          
          # 1. æ‹‰å–æœ€æ–°é•œåƒ
          # âš ï¸ æ³¨æ„è¿™é‡Œä¹Ÿä½¿ç”¨äº†å˜é‡æ‹¼æ¥ï¼Œç¡®ä¿åå­—ä¸€è‡´
          docker pull ${{ secrets.DOCKER_USERNAME }}/bug-bounty-lite-vue:latest
          
          # 2. é‡æ–°åˆ›å»º Vue å®¹å™¨ (ä½¿ç”¨ -d åå°è¿è¡Œ)
          docker compose up -d vue-app
          
          # 3. æ¸…ç†æ—§é•œåƒ (é‡Šæ”¾ç£ç›˜ç©ºé—´)
          docker image prune -f
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
