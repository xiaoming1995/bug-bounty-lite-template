name: Deploy via SCP (Compressed & High Timeout)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    timeout-minutes: 720 # è®¾ç½®è¶…æ—¶æ—¶é—´
    steps:
    # 1. æ‹‰å–ä»£ç 
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. æ„å»ºé•œåƒ (åœ¨ GitHub æœåŠ¡å™¨ä¸Š)
    - name: Build Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/bug-bounty-lite-vue:latest .

    # 3. ä¿å­˜å¹¶å‹ç¼©é•œåƒ (å…³é”®ä¿®æ”¹ï¼šåŠ äº† gzip å‹ç¼©ï¼Œä½“ç§¯å‡å° 70%)
    - name: Save and Compress Image
      run: |
        docker save ${{ secrets.DOCKER_USERNAME }}/bug-bounty-lite-vue:latest | gzip > vue-deploy.tar.gz

    # 4. ä¼ è¾“å‹ç¼©åŒ… (å…³é”®ä¿®æ”¹ï¼štimeout è®¾ç½®ä¸º 600ç§’/10åˆ†é’Ÿ)
    - name: Copy Compressed File to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "vue-deploy.tar.gz"
        target: "/opt/deploy/"
        timeout: "600s" # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 10 åˆ†é’Ÿ
        debug: true     # å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œæ–¹ä¾¿çœ‹å¡åœ¨å“ªé‡Œ

    # 5. SSH ç™»å½•è§£å‹å¹¶å¯åŠ¨
    - name: Load Image and Restart
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        timeout: "600s" # SSH æ‰§è¡Œå‘½ä»¤ä¹Ÿå¤šç»™ç‚¹æ—¶é—´
        script: |
          echo "ğŸ“¦ æ¥æ”¶åˆ°å‹ç¼©åŒ…ï¼Œå¼€å§‹è§£å‹åŠ è½½..."
          cd /opt/deploy
          
          # 1. è§£å‹å¹¶åŠ è½½é•œåƒ (On-the-fly è§£å‹ï¼Œä¸å ç”¨é¢å¤–ç£ç›˜)
          gunzip -c vue-deploy.tar.gz | docker load
          
          # 2. é‡å¯å®¹å™¨ (å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨)
          docker compose up -d --force-recreate vue-app
          
          # 3. æ¸…ç†æ–‡ä»¶
          rm vue-deploy.tar.gz
          docker image prune -f
          
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"